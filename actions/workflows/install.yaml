---
version: '2.0'

bitovi_packs.install:
  input:
    - packs
    - register
    - env
    - force
    - python3

  output:
    result: "{{ _.diagnosis }}"

  tasks:

    download_pack:
      action: "packs.download"
      parameters:
        packs: "{{packs}}"
        force: "{{force}}"
      publish:
        packs_status: "{{ task('download_pack').result }}"
      on-success: "make_a_prerun"

    make_a_prerun:
      action: "packs.virtualenv_prerun"
      parameters:
        packs_status: "{{ _.packs_status }}"
      publish:
        filtered_packs: "{{ task('make_a_prerun').result}}"
      on-success: "get_pack_dependencies"

    get_pack_dependencies:
      action: "bitovi_packs.get_pack_dependencies"
      parameters:
        packs: "{{ _.filtered_packs }}"
      publish:
        packs_dependencies: "{{ task('get_pack_dependencies').result }}"
      on-success:
        - install_pack_dependencies: "{{ _.packs_dependencies | length }}"
        - install_python_dependencies: "{{ not _.packs_dependencies | length }}"

    install_pack_dependencies:
      action: "packs.install"
      with-items: pack_dependencies in {{ _.packs_dependencies }}
      parameters:
        packs: "{{ pack_dependencies['dependencies'] }}"
        register: "{{ _.register }}"
        env: "{{ _.env }}"
        force: "{{ _.force }}"
        python3: "{{ _.python3 }}"
      on-success: "install_python_dependencies"

   install_python_dependencies:
      join: all
      action: "packs.setup_virtualenv"
      parameters:
        packs: "{{ _.filtered_packs }}"
        env: "{{env}}"
        python3: "{{python3}}"
      on-success: "register_pack"

   register_pack:
      action: "packs.load"
      parameters:
        register: "{{register}}"
        packs: "{{ _.filtered_packs }}"